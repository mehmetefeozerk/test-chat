<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Özel Konuşma Odası</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="https://atugatran.github.io/FontAwesome6Pro/css/all.min.css">
</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');
    body,html{
        margin:0;
        width: 100%;
        height: 100%;
    }
    body{
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
        height: 100%;
        background-color: rgba(8, 71, 153,0.5);
        overflow: hidden;
    }
    *{
        box-sizing: border-box;
    }
::-webkit-scrollbar {
  width: 0.3rem;  
  height: 0.3rem; 
}

::-webkit-scrollbar-track {
  background: #f1f1f1; 
  border-radius: 10px;
  margin-right: 5px;
}

::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
  transition: background 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
  background: #555;  
}

.message-container {
    width: 80%;
    height: 90vh;
    min-height: 100%;
    background-color: #dae3f0;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-sizing: border-box;
    margin-right: 5px;
    margin-left: 5px;
    border: 2px solid gray;
    overflow-y: auto;
}
.messages{
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    padding: 20px;
    overflow-y: auto;
}

.message {
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    font-family: Montserrat, sans-serif;
    font-weight: 500;
    font-size: 0.95rem;
    position: relative;
    display: flex;
    flex-direction: column;
    max-width: 80%;
    min-width: 10rem;
    word-wrap: break-word; 
    overflow-wrap: break-word;
    box-shadow: 0px 0px 5px darkgray;
}

.sender {
    background-color: #005c4b;
    border-left: 4px solid rgba(255, 255, 255, 0.2);
    align-self: flex-end;
}

.sender .message-header {
    display: flex; 
    justify-content: space-between;
    font-size: 14px; 
    margin-bottom: 12px;
}

.sender .name {
    font-weight: bold;
    margin-right: 5px;
    color: white;
}

.sender .time {
    color: rgb(200, 200, 200);
    font-size: 0.9em;;
}

.sender .message-text {
    color: white;
    font-size: 0.85rem;
    font-weight: 500;
    line-height: 1em;
    margin: 5px;
}

.receiver {
    background-color: rgb(42, 54, 61);
    border-left: 4px solid rgba(255, 255, 255, 0.2);
    align-self: flex-start;
    color: white;
}

.receiver .message-header {
    display: flex; 
    justify-content: space-between;
    font-size: 14px; 
    margin-bottom: 12px;
}

.receiver .name {
    font-weight: bold;
    margin-right: 5px;
    color: white;
}

.receiver .time {
    color: rgb(200, 200, 200);
    font-size: 0.9em;
}

.receiver .message-text {
    color: white;
    font-size: 0.85rem;
    font-weight: 500;
    line-height: 1em;
    margin: 5px;
}

.message-header span {
    text-align: right;
}

.message-container .message:not(:last-child) {
    margin-bottom: 10px;
}
#isim_div{
    display: none;
}
#isim_sil{
    display: none;
}
#baslik {
    display: flex;
    align-items: center; 
    position: relative;
    height: 2.5rem;
    background-color: #074799;
    padding: 10px;
    color: white;
    font-family: Montserrat;
    border-bottom:2px solid black;
}

#baslik #oturum_name_div {
    margin: 0; 
    position: absolute;
    left: 0;
    background-color: #001A6E;
    color: white;
    font-weight: bold;
    height: 100%;
    display: flex;
    padding: 0px 10px;
    align-items: center;
    max-width: 20rem;
    white-space: pre;
    overflow: hidden;
}

#baslik #sunucu_div {
    margin: 0; 
    position: absolute;
    right: 0;
    background-color: #001A6E;
    color: white;
    font-weight: bold;
    height: 100%;
    display: flex;
    padding: 0px 10px;
    align-items: center;
    white-space: pre;
    max-width: 20rem;
}

#baslik h1 {
    font-size: 1.7rem;
    margin: 0; 
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-wrap: nowrap;
}

#main{
    display: flex;
    justify-content: space-between;
    height: 100%;
    width: 100%;
    padding-bottom: 3px;
}
#inputs {
    width: 20%;
    height: 100%;
    background-color: #dae3f0;
    padding: 10px;
    padding-top:5px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    border-radius: 12px;
    border:2px solid gray;
}

#inputs input{
    outline: none;
    border:2px solid gray !important;
    height: 50%;
    min-height: 2rem;
}

#emoji-picker {
    margin-top: 10px;
    display: flex;
    justify-content: flex-start;
    align-items: center;
}

#emoji-picker button {
    margin-right: 5px;
}

#isim_div {
    flex-direction: column;
    gap: 10px;
}

#isim_div input {
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
    width: 100%;
}

#isim_div button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

#isim_div button:hover {
    background-color: #218838;
}

#isim_sil {
    background-color: #dc3545;
}

#isim_sil:hover {
    background-color: #c82333;
}
.toast-message{
    font-family: Montserrat;
    font-weight: bold;
}
#oturum_name{
    margin-left: 5px;
    font-weight: 500;
}

.swal2-success-ring::before {
    content: "❤️";
    font-size: 5rem;
    position: absolute;
    left:-15px;
    display: block;
    text-align: center;
}
.swal2-container{
    font-family: Montserrat;
}
.bg_heart {
    position: relative;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden
 }

.heart {
    position: absolute;
    top: -50%;
    -webkit-transform: rotate(-45deg);
    -moz-transform: rotate(-45deg);
    -m-transform: rotate(-45deg);
    transform: rotate(-45deg);
    z-index:-1;
 }

.heart:before {
    position: absolute;
    top: -50%;
    left: 0;
    display: block;
    content: "";
    width: 100%;
    height: 100%;
    background: inherit;
    border-radius: 100%;
}

.heart:after {
    position: absolute;
    top: 0;
    right: -50%;
    display: block;
    content: "";
    width: 100%;
    height: 100%;
    background: inherit;
    border-radius: 100%;
}

@-webkit-keyframes love {
  0%{top:110%}
}
@-moz-keyframes love {
  0%{top:110%}
}
@-ms-keyframes love {
  0%{top:110%}
}
@keyframes love {
  0%{top:110%}
}

@media (max-width: 900px) {
#baslik h1{
    display: none;
}
.message{
    font-size: 0.8rem !important;
}
#baslik{
    font-size: 0.8rem;
}

#isim_sil{
    font-size: min(2vw,0.8rem);
}

}
.mesaj-div{
    width: 100%;
    display: flex;
    gap:5px;
    height: 2.3rem;
    padding: 5px;
}
.mesaj-div input{
    width: 90%;
    padding: 2px;
    height: 100%;
    outline: none;
}
.mesaj-div button{
    width: 10%;
    min-width: 35px;
    min-height: 26px;
    padding: 5px;
    height: 100%;
    outline: none;
}
#isim_sil{
    width: 5%;
    font-weight: bold;
    color: white;
    font-family: Montserrat;
    padding: 5px;
    border: 2px solid black;
    box-sizing: border-box;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 26px;
    min-height: 26px;
    font-size: 0.8rem;
}
.bildiri{
    background-color: rgba(255, 0, 0, 0.5);
    padding: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: bold;
    font-family: Montserrat;
    font-size: 0.7rem;
    height: 1.5rem;
    width: 100%;
    margin-bottom: 10px;
}
header{
    min-height:30px;
}
</style>
</body>
    <header id="baslik">
    <p id="oturum_name_div" style="margin:0;">Açık Hesap: <span id="oturum_name"></span></p>
    <p id="sunucu_div"  style="margin:0;">Sunucuya <span id="sunucu_sayi"></span> Kişi Bağlı</p>
    <h1>Özel Konuşma Odası</h1>
</header>
    <div id="main">
        <div id="inputs">
    <div id="isim_div">
        <p style="margin:0; margin-top:5px; font-family:Montserrat">İsminizi Girerek Sohbete Girin</p>
    <input type="text" id="name" placeholder="İsim...">
    <button onclick="isimBelirle()">Oturum Aç</button>
    </div>
    </div>
    <div class="message-container">
        <div class="messages">
            
        </div>
        <div class="mesaj-div">
    <button id="isim_sil" onclick="isimSil()"><i class="fa-solid fa-power-off"></i></button>
    <input type="text" id="text">
    <button onclick="mesajGonder()" style="color:white; background-color: gray; font-size:1rem; display:flex; align-items:center; justify-content:center; border:2px solid black; cursor:pointer;" id="mesaj_gonder"><i class="fa-regular fa-paper-plane-top"></i></button>
        </div>
</div>

</div>

    <script>
    var ws = null;
        if(window.location.protocol === 'https:'){
ws = new WebSocket('wss://'+window.location.hostname);
}else{
ws = new WebSocket('ws://'+window.location.hostname);
}
ws.onopen = function () {
    if(localStorage.getItem("oturum_name")){
    gonder({type:'set_nickname', nickname:localStorage.getItem("oturum_name")});
}
};

ws.onmessage = function (event) {
    let data = event.data;
    const message = JSON.parse(data);
    console.log(message.message);
    console.log(message.name); 

    const messageContainer = $(".messages");
if(message.type == 'mesaj'){
    if (localStorage.getItem("oturum_name") == message.name) {
        console.log("Gelen mesaj kendi mesajım yani sender");

        const senderMessage = `
            <div class="message sender">
                <div class="message-header">
                    <span class="name">${message.name}</span>
                    <span class="time">${new Date().toLocaleTimeString('tr-TR', { hour12: true, hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <p class="message-text">${message.message}</p>
            </div>
        `;
        messageContainer.append(senderMessage);
    } else {
        console.log("Gelen mesaj başka bir kişiden");

        const receiverMessage = `
            <div class="message receiver">
                <div class="message-header">
                    <span class="name">${message.name}</span>
                    <span class="time">${new Date().toLocaleTimeString('tr-TR', { hour12: true, hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <p class="message-text">${message.message}</p>
            </div>
        `;
        messageContainer.append(receiverMessage);
    }

    messageContainer.scrollTop(messageContainer[0].scrollHeight);
}
if(message.type == 'sunucu_sayi'){
    console.log(message.count);
    $('#sunucu_sayi').text(message.count);
}
if(message.type=='disconnect_sunucu'){
    const disconnectMesaj = `<div class="bildiri">${message.nickname} Sunucudan Ayrıldı</div>`;
    messageContainer.append(disconnectMesaj);
}
if(message.type=='sunucu_giris'){
    const girisMesaj = `<div class="bildiri" style='background-color:rgba(0,255,0,0.5);'>${message.nickname} Sunucuya Katıldı</div>`;
    messageContainer.append(girisMesaj);
}
};


ws.onclose = function handleClose() {
    console.log('WebSocket connection closed');
    Swal.fire({
            icon: 'error',
            title: 'Bağlantı Kesildi',
            text: 'Sunucu bağlantısı kesildi,Lütfen sayfayı yenileyiniz.',
            showConfirmButton: false,
        });
};

ws.onerror = function handleError(error) {
    console.error('WebSocket error occurred:', error);
};

function gonder(data){
    if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data)); 
        console.log('Gönderilen veri:', data); 
    } else {
        console.error('WebSocket bağlantısı açık değil!');
    }
}

function mesajGonder(){
    var mesaj = $('#text').val();
    if(mesaj == '' || mesaj == null){
        toastr.warning('Boş Mesaj Atamazsınız!');
    }else{
    var name = localStorage.getItem("oturum_name");
    console.log(mesaj);
try{
    gonder({type:'mesaj', message:mesaj, name:name});
    console.log("mesaj gonderildi");
} catch{
    console.log("mesaj gonderilmedi");
}
    $('#text').val('');
}
};

function isimBelirle(){
    if($('#name').val() == '' || $('#name').val() == null){
        toastr.warning('İsmi Boş Bırakamazsın');
    }else{
    localStorage.setItem("oturum_name", $('#name').val());
    $('#isim_div').css('display','none');
    $(".mesaj-div").each(function() { $(this).css({"display": "flex" });});
    $('#isim_sil').css('display','block');
    $('#oturum_name').text($('#name').val());
    $('#inputs').css('width','20%');
    $('.message-container').css('display','flex');
    $('#main').css('padding','0');
    $('#inputs').css('display','none');
    $('.message-container').css('width','100%');
    $('#oturum_name_div').css('display','flex');
    $('#sunucu_div').css('display','flex');
    if(window.innerWidth < 900){
    $('#baslik h1').css('display','none');
}
    gonder({type:'set_nickname', nickname:$('#name').val()});
    if($('#name').val().toLowerCase() == 'hatice'){
        location.reload();
    }
}
}

function isimSil(){
    let oncekiName =localStorage.getItem("oturum_name")
    localStorage.removeItem("oturum_name")
    $('#isim_div').css('display','flex');
    $('#name').attr('placeholder',oncekiName);
    $('#name').val(oncekiName);
    $('#isim_sil').css('display','none');
    $(".mesaj-div").each(function() { $(this).css({"display": "none" });});
    $('#inputs').css('display','flex');
    $('.message-container').css('width','80%');
    $('#oturum_name').text('');
    location.reload();   
}
document.addEventListener('DOMContentLoaded', function() {
    var oturum_name = localStorage.getItem("oturum_name");

if(!oturum_name){
    $('#isim_div').css('display','flex');
    $('#isim_sil').css('display','none');
    $(".mesaj-div").each(function() { $(this).css({"display": "none", });});
    $('#inputs').css('width','100%');
    $('.message-container').css('display','none');
    $('#main').css('padding','5px');
    $('#oturum_name_div').css('display','none');
    $('#sunucu_div').css('display','none');
    if(window.innerWidth < 900){
    $('#baslik h1').css('display','block');
}
}else{
    $('#inputs').css('display','none');
    $('.message-container').css('width','100%');
    $(".mesaj-div").each(function() { $(this).css({"display": "flex", });});
    $('#isim_sil').css('display','block');

    $('#oturum_name').text(oturum_name);
    if(oturum_name.toLowerCase() == "hatice"){
    $('#oturum_name').text(oturum_name+' (yani bebeğim <3)');
        Swal.fire({
            icon: 'success',
            title: 'Hoşgeldin Sevgilimmm!',
            text: 'Birtanem Gelmiş Hoşgelmişş.',
            showConfirmButton: true,
            confirmButtonText: 'Devam et',
            timer: 2000,  
        });
    
var love = setInterval(function() {
    var r_num = Math.floor(Math.random() * 20) + 1;
    var r_size = Math.floor(Math.random() * 15) + 10;
    var r_left = Math.floor(Math.random() * 100) + 1;
    var r_bg = Math.floor(Math.random() * 15) + 100;
    var r_time = 200;

    $('#main').append("<div class='heart' style='width:" + r_size + "px;height:" + r_size + "px;left:" + r_left + "%;background:rgba(255," + (r_bg - 25) + "," + r_bg + ",1);-webkit-animation:love " + r_time + "s ease;-moz-animation:love " + r_time + "s ease;-ms-animation:love " + r_time + "s ease;animation:love " + r_time + "s ease'></div>");

    $('.bg_heart').append("<div class='heart' style='width:" + (r_size - 10) + "px;height:" + (r_size - 10) + "px;left:" + (r_left + r_num) + "%;background:rgba(255," + (r_bg - 25) + "," + (r_bg + 25) + ",1);-webkit-animation:love " + (r_time + 5) + "s ease;-moz-animation:love " + (r_time + 5) + "s ease;-ms-animation:love " + (r_time + 5) + "s ease;animation:love " + (r_time + 5) + "s ease'></div>");

    $('.heart').each(function() {
        var top = $(this).css("top").replace(/[^-\d\.]/g, '');
        var width = $(this).css("width").replace(/[^-\d\.]/g, '');
        if (top <= -100 || width >= 150) {
            $(this).detach();
        }
    });
}, 1000);
$('body').css('overflow','hidden');
$('.message-container').css('background-color','rgba(255,255,255,0.7)');
    }
}


$(document).on('keydown', function(event) {
    if ($(':focus').is('input') && !$('#text').is(':focus')) {
            return; 
        }
    const input = $('#text');
    input.focus();
    if (event.key === 'Enter' && !input.val() == '') {
        event.preventDefault();
        mesajGonder();
    } 

});

$(document).ready(function() {
    const maxName = 20;
    const maxMessage = 700;

    $('#name').on('input', function() {
        const inputValue = $(this).val();
        if(inputValue.length > maxName){
            $(this).val(inputValue.substring(0, maxName));
                toastr.warning(`İsim en fazla ${maxName} karakter olabilir.`);
        }
    });

    $('#text').on('input', function() {
        const inputValue = $(this).val();
        if(inputValue.length > maxMessage){
            $(this).val(inputValue.substring(0, maxMessage));
                toastr.warning(`Mesaj en fazla ${maxMessage} karakter olabilir.`);
        }
    });

});

});

window.onscroll = function() {
  document.body.scrollTop = 0;  
  document.documentElement.scrollTop = 0;
};
window.onresize = function() {
if(window.innerWidth > 900){
    $('#baslik h1').css('display','block');
}else if(localStorage.getItem("oturum_name")){
    $('#baslik h1').css('display','none');
}
};

toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "preventDuplicates": true,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    };

    </script>
</body>
</html>
